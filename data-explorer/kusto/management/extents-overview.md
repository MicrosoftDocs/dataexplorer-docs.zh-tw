---
title: 擴展區(資料分片) - Azure 資料資源管理員 |微軟文件
description: 本文介紹 Azure 資料資源管理器中的擴展區(數據分片)。
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: rkarlin
ms.service: data-explorer
ms.topic: reference
ms.date: 03/13/2020
ms.openlocfilehash: 16afb2dc7d2310e9e63ec3465937ac84c96b27e4
ms.sourcegitcommit: 47a002b7032a05ef67c4e5e12de7720062645e9e
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/15/2020
ms.locfileid: "81521007"
---
# <a name="extents-data-shards"></a>範圍(資料分片)

## <a name="overview"></a>概觀

Kusto 是為支援具有大量記錄(行)和大量數據的表而構建的。 為了能夠處理如此大的表,Kusto 將每個表的數據劃分為更小的「Tablet」,稱為**數據分片**或**擴展盤區**(這兩個術語是同義詞),以便所有表的擴展盤區的合併都保存表的數據。 然後,單個擴展盤區將保持小於單個節點的容量,並且擴展區分佈在群集的節點上,實現橫向擴展。 

人們可以把一個範圍看作是一種小桌子。 範圍包含中繼資料(指示範圍中資料的架構和其他資訊,如其創建時間和與範圍中的數據關聯的可選標記)和資料。 此外,範圍通常包含允許 Kusto 高效地查詢數據的資訊,例如範圍中每列數據的索引,以及編碼列數據(如果對列數據進行編碼)的編碼字典。 因此,表的數據是表區中所有數據的合併。

範圍是不*可變的*。 創建後,將永遠不會修改範圍,並且只能查詢範圍、重新分配到其他節點或從表中刪除。 數據修改是通過創建一個或多個新擴展區並在事務上將舊擴展盤區與新擴展區交換來進行的。

範圍包含記錄的集合,物理排列在列中。
此技術(稱為**列存儲**)使可以有效地編碼和壓縮數據(因為同一列的不同值通常相互"相似"),並使對大數據跨度的查詢更有效,因為只需要載入查詢使用的列。 在內部,範圍中的每個數據列都細分為段,並將段細分為塊。 此劃分(查詢無法觀察到)允許 Kusto 優化列壓縮和索引。

為了保持查詢效率,較小的範圍被合併到更大的範圍中。
這是 Kusto 根據配置的[合併策略](mergepolicy.md)和[分片策略](shardingpolicy.md)自動執行的,作為後台進程。
將擴展區合併在一起可降低要跟蹤大量擴展盤區的管理開銷,但更重要的是,它允許 Kusto 優化其索引並改進壓縮。 一旦範圍達到特定限制(如大小),範圍合併將停止,因為超出特定點合併範圍會減少而不是提高效率。

在表上定義[資料分區策略](partitioningpolicy.md)時,擴展區在創建後(引入後)將經歷另一個後台進程。 此過程從源擴展區重新引入數據並創建*同質*範圍,其中表的*分區鍵*列的值都屬於同一分區。 如果策略包含*哈希分區鍵*,則保證屬於同一分區的所有同質範圍都分配給群集中的同一數據節點。

> [!NOTE]
> 範圍級操作(如合併、更改擴展盤區標記等)不會修改現有擴展盤區。
> 相反,在這些操作中根據現有源擴展區創建新的擴展盤區,然後這些新擴展盤區在單個事務中替換其祖先。

因此,範圍的常見「生命週期」是:

1. 範圍由**引入**操作創建。
2. 擴展區與其他範圍合併。 當要合併的擴展盤區較小時,Kusto 實際上會對它們執行引入過程(這稱為**重建**)。 一旦擴展盤達到一定大小,合併將僅針對索引進行,並且不會修改存儲區中的資料工件。
3. 合併的範圍(可能跟蹤其血統到其他合併擴展區等)最終由於保留策略而被刪除。 當根據時間(較舊的 x 小時/天)丟棄擴展盤區時,合併範圍內最新範圍的創建日期將納入計算。

## <a name="extent-ingestion-time"></a>範圍攝入時間

每個範圍更重要的資訊之一是它的攝入時間。 庫斯托將此時間用於:

1. 保留(較早前攝入的擴展盤區將提前刪除)。
2. 緩存(最近攝入的面積會更熱)。
3. 採樣(使用查詢操作(如`take`時,喜歡最近擴展盤區)。

事實上,Kusto 追蹤`datetime`每個範圍的兩`MinCreatedOn`個`MaxCreatedOn`值 : 和 。
這些值的開頭相同,但當擴展區與其他擴展盤區合併時,生成的範圍的值分別是所有合併擴展盤區上的最小值和最大值。

範圍的攝入時間可通過三種方式之一設置:

1. 通常,執行引入的節點根據其本地時鐘設置此值。
2. 如果在表上設置了**引入時間策略**,則執行引入的節點會根據群集的管理員節點的本地時鐘設置此值,從而保證所有以後的引入都具有較高的引入時間值。
3. 用戶端可能會設置此時間。 (例如,如果用戶端希望重新引入數據,並且不希望重新引入的數據顯示為延遲到達(例如用於保留目的),則此功能非常有用。    

## <a name="extent-tagging"></a>範圍標記

作為隨範圍存儲的中繼資料的一部分,Kusto 支援將多個可選*範圍標記*附加到該範圍。 範圍標記(或簡稱*標記*)是與範圍關聯的字串。 可以使用[.show 擴展區](extents-commands.md#show-extents)命令查看與擴展區關聯的標記,以及[範圍標記()](../query/extenttagsfunction.md)函數來查看與擴展區中的記錄關聯的標記。
範圍標記可用於有效地描述與擴展區中的所有數據相關的屬性。
例如,可以在攝入期間添加一個範圍標記,指示要引入的數據的來源,並在以後使用該標記。 在描述數據時,當兩個或多個擴展區合併時,其關聯的標記也會通過將生成的擴展區標記合併為要合併的擴展區的所有範圍標記的合併。

Kusto 為所有範圍標記分配特殊含義,其值具有格式*前綴**後綴*,其中*首綴*為:

* `drop-by:`
* `ingest-by:`

## <a name="drop-by-extent-tags"></a>"下降:"範圍標記

以前綴開頭的**`drop-by:`** 標記可用於控制要與哪些其他擴展區合併;具有給定`drop-by:`標記的擴展盤區可以合併在一起,但它們不會與其他擴展盤區合併。 這允許使用者根據標記`drop-by:`發出命令以丟棄範圍,例如以下命令:

```kusto
.ingest ... with @'{"tags":"[\"drop-by:2016-02-17\"]"}'

.drop extents <| .show table MyTable extents where tags has "drop-by:2016-02-17" 
```

### <a name="performance-notes"></a>效能說明

* 不建議過度使用`drop-by`標記。 支援以上述方式刪除數據,用於很少發生的事件,不是替換記錄級數據,而且關鍵依賴於以這種方式標記的數據是"笨重"這一事實。 嘗試為每個記錄或少量記錄提供不同的標記可能會導致對性能的嚴重影響。
* 在資料被攝錄後不需要一段時間的情況下,建議[刪除標記](extents-commands.md#drop-extent-tags)。

## <a name="ingest-by-extent-tags"></a>"按:"範圍標記

以前綴開頭的**`ingest-by:`** 標記可用於確保只引入一次數據。 用戶可以發出一個引入命令,防止通過`ingest-by:`**`ingestIfNotExists`** 使用 屬性使用此特定標記的擴展區時引入數據。
和 的`ingestIfNotExists`值`tags`都是字串陣列,序列化為 JSON。

以下範例僅引入資料一次(第 2 個和第 3 個指令將不執行任何操作):

```kusto
.ingest ... with (tags = '["ingest-by:2016-02-17"]')

.ingest ... with (ingestIfNotExists = '["2016-02-17"]')

.ingest ... with (ingestIfNotExists = '["2016-02-17"]', tags = '["ingest-by:2016-02-17"]')
```

> [!NOTE]
> 在常見情況下,引入命令可能包含`ingest-by:`標記`ingestIfNotExists`和 屬性,設置為相同的值(如上面的第3個命令所示)。

### <a name="performance-notes"></a>效能說明

- 不建議`ingest-by`過度使用標記。
如果已知提供 Kusto 的管道存在資料重複,則建議在將數據引入 Kusto 之前盡可能解決這些問題,並且僅在`ingest-by`Kusto 中使用標記,以便引入 Kusto 的元件本身可以引入重複(例如,有一種重試機制可以與已在進行中的調用重疊)。 嘗試為每個引入調用設置唯`ingest-by`一標記可能會導致對性能產生嚴重影響。
- 在資料被攝錄後不需要一段時間的情況下,建議[刪除標記](extents-commands.md#drop-extent-tags)。